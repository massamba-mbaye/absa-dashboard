<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Test CSRF Protection</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a2e;
            color: #e5e7eb;
        }
        .test-section {
            background: #2a2a3a;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
        }
        button {
            background: #4b3795;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #6b57b1;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
        }
        .success {
            background: rgba(81, 207, 102, 0.2);
            color: #51cf66;
        }
        .error {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
    </style>
</head>
<body>
    <h1>üõ°Ô∏è Test CSRF Protection & Headers</h1>

    <div class="test-section">
        <h2>1. Test r√©cup√©ration CSRF Token</h2>
        <button onclick="testGetToken()">R√©cup√©rer le token CSRF</button>
        <div id="token-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>2. Test requ√™te avec CSRF Token</h2>
        <button onclick="testWithToken()">Envoyer requ√™te AVEC token</button>
        <div id="with-token-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>3. Test requ√™te sans CSRF Token</h2>
        <button onclick="testWithoutToken()">Envoyer requ√™te SANS token</button>
        <div id="without-token-result" class="result"></div>
    </div>

    <div class="test-section">
        <h2>4. V√©rifier Headers de s√©curit√©</h2>
        <button onclick="testHeaders()">V√©rifier les headers</button>
        <div id="headers-result" class="result"></div>
    </div>

    <script>
        let csrfToken = null;

        async function testGetToken() {
            const result = document.getElementById('token-result');
            result.textContent = 'Chargement...';

            try {
                const response = await fetch('../api/admin/auth.php?action=get-csrf-token');
                const data = await response.json();

                if (data.success && data.data.csrf_token) {
                    csrfToken = data.data.csrf_token;
                    result.className = 'result success';
                    result.textContent = `‚úÖ Token r√©cup√©r√©: ${csrfToken.substring(0, 20)}...`;
                } else {
                    throw new Error('Pas de token dans la r√©ponse');
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `‚ùå Erreur: ${error.message}`;
            }
        }

        async function testWithToken() {
            const result = document.getElementById('with-token-result');
            result.textContent = 'Chargement...';

            if (!csrfToken) {
                result.className = 'result error';
                result.textContent = '‚ùå R√©cup√©rez d\'abord le token CSRF';
                return;
            }

            try {
                // Tester avec l'endpoint refresh-session qui n√©cessite CSRF
                const response = await fetch('../api/admin/auth.php?action=refresh-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    }
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    result.className = 'result success';
                    result.textContent = `‚úÖ Requ√™te accept√©e avec token CSRF\nR√©ponse: ${JSON.stringify(data, null, 2)}`;
                } else {
                    result.className = 'result error';
                    result.textContent = `‚ùå Requ√™te refus√©e: ${data.error || 'Erreur inconnue'}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `‚ùå Erreur: ${error.message}`;
            }
        }

        async function testWithoutToken() {
            const result = document.getElementById('without-token-result');
            result.textContent = 'Chargement...';

            try {
                // Tester SANS token CSRF
                const response = await fetch('../api/admin/auth.php?action=refresh-session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();

                if (response.status === 403 && data.code === 'CSRF_TOKEN_INVALID') {
                    result.className = 'result success';
                    result.textContent = `‚úÖ Protection CSRF fonctionne!\nRequ√™te bloqu√©e: ${data.error}`;
                } else {
                    result.className = 'result error';
                    result.textContent = `‚ùå PROBL√àME: Requ√™te accept√©e sans token!\nR√©ponse: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                result.className = 'result error';
                result.textContent = `‚ùå Erreur: ${error.message}`;
            }
        }

        async function testHeaders() {
            const result = document.getElementById('headers-result');
            result.textContent = 'V√©rification...';

            try {
                const response = await fetch('../api/admin/auth.php?action=check-session');

                const headers = {
                    'X-Frame-Options': response.headers.get('X-Frame-Options'),
                    'X-Content-Type-Options': response.headers.get('X-Content-Type-Options'),
                    'X-XSS-Protection': response.headers.get('X-XSS-Protection'),
                    'Content-Security-Policy': response.headers.get('Content-Security-Policy'),
                    'Referrer-Policy': response.headers.get('Referrer-Policy'),
                    'Cache-Control': response.headers.get('Cache-Control')
                };

                let output = '‚úÖ Headers de s√©curit√© d√©tect√©s:\n\n';
                let allPresent = true;

                for (const [name, value] of Object.entries(headers)) {
                    if (value) {
                        output += `‚úì ${name}: ${value.substring(0, 50)}${value.length > 50 ? '...' : ''}\n`;
                    } else {
                        output += `‚úó ${name}: NON D√âFINI\n`;
                        allPresent = false;
                    }
                }

                result.className = allPresent ? 'result success' : 'result error';
                result.textContent = output;
            } catch (error) {
                result.className = 'result error';
                result.textContent = `‚ùå Erreur: ${error.message}`;
            }
        }
    </script>
</body>
</html>
